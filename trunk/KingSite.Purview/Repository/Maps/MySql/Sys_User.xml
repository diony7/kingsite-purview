<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by BatisMap.cst at 2009-08-03 9:32:51
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="Sys_User"
	xmlns="http://ibatis.apache.org/mapping"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

    <alias>
        <typeAlias alias="Sys_User" type="KingSite.Purview.Domain.Sys_User, KingSite.Purview" />
    </alias>

    <resultMaps>
        <resultMap id="FullResultMap" class="Sys_User">
            <result property="Id" column="Id"/>
            <result property="ApplicationName" column="ApplicationName"/>
            <result property="Name" column="Name"/>
            <result property="DisplayName" column="DisplayName"/>
            <result property="Email" column="Email"/>
            <result property="Comment" column="Comment"/>
            <result property="Password" column="Password"/>
            <result property="PasswordKey" column="PasswordKey"/>
            <result property="PasswordQuestion" column="PasswordQuestion"/>
            <result property="PasswordAnswer" column="PasswordAnswer"/>
            <result property="IsApproved" column="IsApproved"/>            
            <result property="LastActivityDate" column="LastActivityDate"/>
            <result property="LastLoginDate" column="LastLoginDate"/>
            <result property="LastPasswordChangedDate" column="LastPasswordChangedDate"/>
            <result property="CreationDate" column="CreationDate"/>
            <result property="IsLockedOut" column="IsLockedOut"/>
            <result property="LastLockedOutDate" column="LastLockedOutDate"/>
            <result property="IsOnLine" column="IsOnLine"/>
            <result property="FailedPasswordAttemptCount" column="FailedPasswordAttemptCount"/>
            <result property="FailedPasswordAttemptWindowStart" column="FailedPasswordAttemptWindowStart"/>
            <result property="FailedPasswordAnswerAttemptCount" column="FailedPasswordAnswerAttemptCount"/>
            <result property="FailedPasswordAnswerAttemptWindowStart" column="FailedPasswordAnswerAttemptWindowStart"/>

        </resultMap>
    </resultMaps>

    <statements>

        <select id="GetCount" parameterClass="Sys_User" resultClass="int">
            SELECT count(*) FROM Sys_User WHERE ApplicationName = #ApplicationName#
        </select>

        <select id="FindAll" resultMap="FullResultMap">
            SELECT *
            FROM Sys_User
        </select>

        <select id="GetAllUsers" parameterClass="map" resultMap="FullResultMap" >
            SELECT * FROM sys_user WHERE ApplicationName = #ApplicationName#
            ORDER BY Name Asc
            Limit #StartRow#, #EndRow#
        </select>

        <select id="FindUsersByEmail" parameterClass="map" resultMap="FullResultMap" >
            SELECT * FROM sys_user
            WHERE ApplicationName = #ApplicationName# and
            Email LIKE concat('%',#EmailToMatch#,'%')
            ORDER BY Name Asc
            Limit #StartRow#, #EndRow#
        </select>

        <select id="FindUsersByName" parameterClass="map" resultMap="FullResultMap" >
            SELECT * FROM sys_user
            WHERE ApplicationName = #ApplicationName# and
            Name LIKE concat('%',#UserNameToMatch#,'%')
            ORDER BY Name Asc
            Limit #StartRow#, #EndRow#
        </select>

        <select id="GetUser_IsNotLockedOut" parameterClass="Sys_User" resultMap="FullResultMap" >
            SELECT * FROM sys_user WHERE name=#Name# AND ApplicationName = #ApplicationName# AND IsLockedOut = 0
        </select>

        <select id="GetUser" parameterClass="Sys_User" resultMap="FullResultMap" >
            SELECT * FROM sys_user WHERE name=#Name# AND ApplicationName = #ApplicationName#
        </select>

        <select id="GetUserNameByEmail" parameterClass="Sys_User" resultMap="FullResultMap" >
            SELECT * FROM sys_user WHERE Email = #Email# AND ApplicationName = #ApplicationName#
        </select>

        <select id="ValidateUser" parameterClass="Sys_User" resultClass="Int32" >
            SELECT count(*)  FROM sys_user where ApplicationName = #ApplicationName# and name=#Name# and password=#Password#
        </select>

        <select id="GetNumberOfUsersOnline" parameterClass="Sys_User" resultClass="int">
            SELECT count(*) FROM Sys_User
            WHERE LastActivityDate > #LastActivityDate# AND ApplicationName = #ApplicationName#
        </select>
        
        <update id="Insert" parameterClass="Sys_User">
            INSERT INTO sys_user (
            Id,
            ApplicationName,
            Name,
            DisplayName,
            Email,
            Comment,
            Password,
            PasswordKey,
            PasswordQuestion,
            PasswordAnswer,
            IsApproved,
            LastActivityDate,
            LastLoginDate,
            LastPasswordChangedDate,
            CreationDate,
            IsLockedOut,
            LastLockedOutDate,
            IsOnLine,
            FailedPasswordAttemptCount,
            FailedPasswordAttemptWindowStart,
            FailedPasswordAnswerAttemptCount,
            FailedPasswordAnswerAttemptWindowStart
            ) VALUES (
            #Id#,
            #ApplicationName#,
            #Name#,
            #DisplayName#,
            #Email#,
            #Comment#,
            #Password#,
            #PasswordKey#,
            #PasswordQuestion#,
            #PasswordAnswer#,
            #IsApproved#,
            #LastActivityDate#,
            #LastLoginDate#,
            #LastPasswordChangedDate#,
            #CreationDate#,
            #IsLockedOut#,
            #LastLockedOutDate#,
            #IsOnLine#,
            #FailedPasswordAttemptCount#,
            #FailedPasswordAttemptWindowStart#,
            #FailedPasswordAnswerAttemptCount#,
            #FailedPasswordAnswerAttemptWindowStart#
            )
        </update>

        <update id="UpdateLogonDate" parameterClass="Sys_User">
            UPDATE sys_user
            SET LastLoginDate = #LastLoginDate#,
            LastActivityDate = #LastActivityDate#
            WHERE name = #Name# AND ApplicationName = #ApplicationName#
        </update>

        <update id="UpdateActiveDate" parameterClass="Sys_User">
            UPDATE sys_user
            SET LastActivityDate = #LastActivityDate#
            WHERE name = #Name# AND ApplicationName = #ApplicationName#
        </update>
        
        <update id="UpdatePassword" parameterClass="Sys_User">
            UPDATE sys_user
            SET Password = #Password#, 
            PasswordKey = #PasswordKey#,
            LastPasswordChangedDate = #LastPasswordChangedDate#
            WHERE name = #Name# AND ApplicationName = #ApplicationName#
        </update>
        
        <update id="UpdatePasswordQuestionAndAnswer" parameterClass="Sys_User">
            UPDATE sys_user
            SET PasswordQuestion = #PasswordQuestion#, 
            PasswordAnswer = #PasswordAnswer#
            WHERE name = #Name# AND ApplicationName = #ApplicationName#
        </update>

        <update id="Delete" parameterClass="Sys_User">
            Delete from sys_user
            WHERE name = #Name# AND ApplicationName = #ApplicationName#;

            Delete from Sys_UserInRole
            WHERE UserName = #Name# AND ApplicationName = #ApplicationName#;
        </update>

        <update id="LockUser" parameterClass="Sys_User">
            UPDATE sys_user
            SET IsLockedOut = 1,
            LastLockedOutDate = #LastLockedOutDate#
            WHERE name = #Name# AND ApplicationName = #ApplicationName#
        </update>

        <update id="UnlockUser" parameterClass="Sys_User">
            UPDATE sys_user
            SET IsLockedOut = 0, 
            LastLockedOutDate = #LastLockedOutDate#
            WHERE name = #Name# AND ApplicationName = #ApplicationName#
        </update>

        <update id="UpdateForMembershipUser" parameterClass="Sys_User">
            UPDATE sys_user
            SET  Email = #Email#,
            Comment = #Comment#,
            IsApproved = #IsApproved#
            WHERE name = #Name# AND ApplicationName = #ApplicationName#
        </update>

        <update id="UpdateFailedPassword" parameterClass="Sys_User">
            UPDATE sys_user
            SET FailedPasswordAttemptCount = #FailedPasswordAttemptCount#,
            FailedPasswordAttemptWindowStart = #FailedPasswordAttemptWindowStart#
            WHERE name = #Name# AND ApplicationName = #ApplicationName#
        </update>

        <update id="UpdateFailedPasswordAnswer" parameterClass="Sys_User">
            UPDATE sys_user
            SET FailedPasswordAnswerAttemptCount = #FailedPasswordAnswerAttemptCount#,
            FailedPasswordAnswerAttemptWindowStart = #FailedPasswordAnswerAttemptWindowStart#
            WHERE name = #Name# AND ApplicationName = #ApplicationName#
        </update>
        
    </statements>
</sqlMap>
